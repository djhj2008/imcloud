#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "plchead.h"
#include "plehead.h"

/*
 ==================================================================

    PowerLine Signal Codec Encoder: Sample prorgram
                                                   (plesmpl.c)

 ------------------------------------------------------------------

    2013.01.24.[Thu] Created by T.SHIBUYA
    2013.06.21.[Fri] Changed by T.SHIBUYA
    2015.05.08.[Fri] Changed by T.ONO

 ------------------------------------------------------------------
    RCS $Id: plesmpl.c,v 1.5 2013/06/24 03:59:22 shibuya Exp $
 ------------------------------------------------------------------
            Copyright (C) 2012-2013  SONY Corporation
           Any unauthorized use is strictly prohibited.
 ==================================================================
*/


/* Constants */
#define	PLC_HEADER_SIZE         16  /* bytes */
#define PLC_L_DATA_SIZE         28  /* bytes */
#define	PLC_V_DATA_SIZE         4   /* bytes */


/* Input Waveforms */
ple_uint16_t	L_in[4][192] = {
{
0x215a,0x3270,0x34f8,0x304c,0x223f,0x247b,0x1ffa,0x1735,
0x21ac,0x260e,0x1981,0x0f53,0x1d1a,0x1522,0x0933,0x0fcc,
0x1aac,0x111e,0x18da,0x1dc0,0x139f,0x1fa3,0x1d7c,0x2308,
0x1bb5,0x22c2,0x325f,0x2fe9,0x2ef5,0x32ea,0x3131,0x2990,
0x2e2b,0x2759,0x2ef2,0x2c9b,0x2286,0x2cdb,0x1545,0x1c1f,
0x206f,0x1e80,0x1cd6,0x07c3,0x11f7,0x1573,0x12f9,0x0dbe,
0x1370,0x0875,0x1a9c,0x15a6,0x22bb,0x29de,0x2d29,0x2a99,
0x256f,0x268e,0x233c,0x2424,0x354e,0x2c71,0x2b0b,0x3284,
0x2628,0x27ea,0x1e2e,0x2a90,0x2497,0x1b78,0x18cf,0x0e01,
0x1376,0x13db,0x080c,0x0c8d,0x111c,0x1620,0x0eb2,0x0d4f,
0x16ac,0x1b8a,0x1e0f,0x1f6e,0x1a6d,0x1dce,0x279a,0x2c97,
0x2e96,0x3b4d,0x2dd6,0x3641,0x3044,0x2f1d,0x3139,0x2ebf,
0x2a3e,0x25d5,0x289f,0x28be,0x1934,0x10af,0x0f26,0x1814,
0x1550,0x1ad5,0x164f,0x0ff3,0x1656,0x0de5,0x1dc1,0x1a86,
0x258b,0x2d00,0x1dbe,0x2e5f,0x23af,0x301c,0x31b5,0x3149,
0x2dd6,0x332b,0x2956,0x24b4,0x2ee4,0x2702,0x26a3,0x2644,
0x22ea,0x10c4,0x1e7f,0x05a9,0x143c,0x1be8,0x0b2f,0x1277,
0x1603,0x0aef,0x054a,0x198d,0x1711,0x1722,0x1cce,0x23ca,
0x23fd,0x1a26,0x2d7e,0x34a7,0x36b2,0x2faa,0x29b4,0x2ce2,
0x2d02,0x3002,0x2b68,0x263a,0x1be0,0x2a39,0x251f,0x16e5,
0x121c,0x16e9,0x0fe3,0x0bd8,0x0f1c,0x0c7b,0x0583,0x0ea6,
0x1768,0x1a52,0x2225,0x1e7c,0x1d7a,0x22ab,0x2967,0x2a38,
0x26f7,0x327c,0x2703,0x2fea,0x3656,0x3201,0x32c5,0x332e,
0x213c,0x29c0,0x26f4,0x29c1,0x2687,0x167b,0x106f,0x09a7
},
{
0x2e39,0x29b7,0x2379,0x2b79,0x2e7a,0x28c3,0x1f87,0x1f60,
0x1d68,0x22b4,0x0bd0,0x1b87,0x0a1a,0x16dc,0x0e15,0x15a7,
0x1214,0x0970,0x0f35,0x0f75,0x15b8,0x1d26,0x2636,0x1680,
0x1c6b,0x2454,0x2eca,0x3378,0x3060,0x2a30,0x2894,0x285f,
0x376a,0x39d3,0x2584,0x2a24,0x29d0,0x17cd,0x2688,0x11dd,
0x131f,0x1e5e,0x1309,0x0cef,0x16ef,0x09a0,0x119c,0x1245,
0x19de,0x15d2,0x1bee,0x1e37,0x1725,0x2097,0x1fcd,0x2c88,
0x27ed,0x282c,0x2e37,0x2ca2,0x2f3b,0x3126,0x39f0,0x2fa9,
0x3686,0x34cf,0x230e,0x2c7f,0x2106,0x1680,0x1910,0x17f4,
0x0e2b,0x0a42,0x0d8d,0x05f6,0x0a54,0x19dd,0x1c71,0x1b22,
0x214e,0x1994,0x20e3,0x27d4,0x26aa,0x246b,0x2aa2,0x2ed9,
0x2952,0x3b44,0x2b8d,0x24ed,0x2dad,0x3185,0x26f9,0x1eeb,
0x29d6,0x2726,0x1e67,0x1129,0x1655,0x08f6,0x14c7,0x0e25,
0x0d92,0x1336,0x0d2c,0x161f,0x10d9,0x1473,0x16c7,0x1cdf,
0x1f0a,0x2213,0x2afc,0x2c4a,0x2724,0x2e8a,0x36f7,0x3705,
0x28f7,0x2e49,0x2d46,0x328a,0x3835,0x2c7b,0x2b7d,0x1824,
0x20dc,0x2403,0x1818,0x1087,0x09c5,0x1263,0x1997,0x1040,
0x0ec9,0x146c,0x0d5a,0x1035,0x10f5,0x187b,0x22c8,0x2299,
0x276a,0x2b4f,0x28ff,0x2cf9,0x2803,0x3850,0x3895,0x280f,
0x3a5d,0x2e8e,0x21f8,0x323b,0x200e,0x2987,0x2a47,0x2112,
0x22b2,0x1246,0x19c8,0x0d3f,0x08be,0x20d7,0x1994,0x1119,
0x102f,0x23a7,0x2190,0x16f9,0x1b2a,0x21d6,0x20cd,0x2bbd,
0x24c9,0x2651,0x3160,0x309a,0x39e5,0x2df4,0x333c,0x3019,
0x1cc4,0x2836,0x2486,0x10d0,0x1898,0x14d1,0x123e,0x197f
},
{
0x215a,0x3270,0x34f8,0x304c,0x223f,0x247b,0x1ffa,0x1735,
0x21ac,0x260e,0x1981,0x0f53,0x1d1a,0x1522,0x0933,0x0fcc,
0x1aac,0x111e,0x18da,0x1dc0,0x139f,0x1fa3,0x1d7c,0x2308,
0x1bb5,0x22c2,0x325f,0x2fe9,0x2ef5,0x32ea,0x3131,0x2990,
0x2e2b,0x2759,0x2ef2,0x2c9b,0x2286,0x2cdb,0x1545,0x1c1f,
0x206f,0x1e80,0x1cd6,0x07c3,0x11f7,0x1573,0x12f9,0x0dbe,
0x1370,0x0875,0x1a9c,0x15a6,0x22bb,0x29de,0x2d29,0x2a99,
0x256f,0x268e,0x233c,0x2424,0x354e,0x2c71,0x2b0b,0x3284,
0x2628,0x27ea,0x1e2e,0x2a90,0x2497,0x1b78,0x18cf,0x0e01,
0x1376,0x13db,0x080c,0x0c8d,0x111c,0x1620,0x0eb2,0x0d4f,
0x16ac,0x1b8a,0x1e0f,0x1f6e,0x1a6d,0x1dce,0x279a,0x2c97,
0x2e96,0x3b4d,0x2dd6,0x3641,0x3044,0x2f1d,0x3139,0x2ebf,
0x2a3e,0x25d5,0x289f,0x28be,0x1934,0x10af,0x0f26,0x1814,
0x1550,0x1ad5,0x164f,0x0ff3,0x1656,0x0de5,0x1dc1,0x1a86,
0x258b,0x2d00,0x1dbe,0x2e5f,0x23af,0x301c,0x31b5,0x3149,
0x2dd6,0x332b,0x2956,0x24b4,0x2ee4,0x2702,0x26a3,0x2644,
0x22ea,0x10c4,0x1e7f,0x05a9,0x143c,0x1be8,0x0b2f,0x1277,
0x1603,0x0aef,0x054a,0x198d,0x1711,0x1722,0x1cce,0x23ca,
0x23fd,0x1a26,0x2d7e,0x34a7,0x36b2,0x2faa,0x29b4,0x2ce2,
0x2d02,0x3002,0x2b68,0x263a,0x1be0,0x2a39,0x251f,0x16e5,
0x121c,0x16e9,0x0fe3,0x0bd8,0x0f1c,0x0c7b,0x0583,0x0ea6,
0x1768,0x1a52,0x2225,0x1e7c,0x1d7a,0x22ab,0x2967,0x2a38,
0x26f7,0x327c,0x2703,0x2fea,0x3656,0x3201,0x32c5,0x332e,
0x213c,0x29c0,0x26f4,0x29c1,0x2687,0x167b,0x106f,0x09a7
},
{
0x2e39,0x29b7,0x2379,0x2b79,0x2e7a,0x28c3,0x1f87,0x1f60,
0x1d68,0x22b4,0x0bd0,0x1b87,0x0a1a,0x16dc,0x0e15,0x15a7,
0x1214,0x0970,0x0f35,0x0f75,0x15b8,0x1d26,0x2636,0x1680,
0x1c6b,0x2454,0x2eca,0x3378,0x3060,0x2a30,0x2894,0x285f,
0x376a,0x39d3,0x2584,0x2a24,0x29d0,0x17cd,0x2688,0x11dd,
0x131f,0x1e5e,0x1309,0x0cef,0x16ef,0x09a0,0x119c,0x1245,
0x19de,0x15d2,0x1bee,0x1e37,0x1725,0x2097,0x1fcd,0x2c88,
0x27ed,0x282c,0x2e37,0x2ca2,0x2f3b,0x3126,0x39f0,0x2fa9,
0x3686,0x34cf,0x230e,0x2c7f,0x2106,0x1680,0x1910,0x17f4,
0x0e2b,0x0a42,0x0d8d,0x05f6,0x0a54,0x19dd,0x1c71,0x1b22,
0x214e,0x1994,0x20e3,0x27d4,0x26aa,0x246b,0x2aa2,0x2ed9,
0x2952,0x3b44,0x2b8d,0x24ed,0x2dad,0x3185,0x26f9,0x1eeb,
0x29d6,0x2726,0x1e67,0x1129,0x1655,0x08f6,0x14c7,0x0e25,
0x0d92,0x1336,0x0d2c,0x161f,0x10d9,0x1473,0x16c7,0x1cdf,
0x1f0a,0x2213,0x2afc,0x2c4a,0x2724,0x2e8a,0x36f7,0x3705,
0x28f7,0x2e49,0x2d46,0x328a,0x3835,0x2c7b,0x2b7d,0x1824,
0x20dc,0x2403,0x1818,0x1087,0x09c5,0x1263,0x1997,0x1040,
0x0ec9,0x146c,0x0d5a,0x1035,0x10f5,0x187b,0x22c8,0x2299,
0x276a,0x2b4f,0x28ff,0x2cf9,0x2803,0x3850,0x3895,0x280f,
0x3a5d,0x2e8e,0x21f8,0x323b,0x200e,0x2987,0x2a47,0x2112,
0x22b2,0x1246,0x19c8,0x0d3f,0x08be,0x20d7,0x1994,0x1119,
0x102f,0x23a7,0x2190,0x16f9,0x1b2a,0x21d6,0x20cd,0x2bbd,
0x24c9,0x2651,0x3160,0x309a,0x39e5,0x2df4,0x333c,0x3019,
0x1cc4,0x2836,0x2486,0x10d0,0x1898,0x14d1,0x123e,0x197f
}
};

ple_uint16_t	V_in[2][192] = {
{
0x386b,0x35fd,0x2d42,0x317c,0x1f50,0x2a06,0x1bc6,0x1b17,
0x1d89,0x1342,0x2127,0x12cb,0x0cd7,0x12ba,0x1269,0x1314,
0x073c,0x1417,0x11c0,0x0fca,0x2074,0x1497,0x178c,0x252d,
0x3108,0x2a37,0x3203,0x37ea,0x2952,0x3570,0x3520,0x3144,
0x22fc,0x2cfe,0x3012,0x229f,0x24b1,0x254b,0x1f7f,0x22a9,
0x1a4b,0x19a1,0x1286,0x1650,0x0cbe,0x14eb,0x0bf0,0x1790,
0x1404,0x14a7,0x135a,0x1f80,0x26b7,0x2188,0x1eb0,0x2b5e,
0x2784,0x2bfc,0x36d1,0x2774,0x3332,0x2a73,0x28e8,0x289e,
0x2c7e,0x1935,0x2353,0x2720,0x1b49,0x1e21,0x1f38,0x0dfa,
0x10c0,0x1cdc,0x0f34,0x117a,0x181b,0x1234,0x0926,0x13ff,
0x1a49,0x167e,0x1522,0x26e1,0x2665,0x25aa,0x2f02,0x27fd,
0x2b9a,0x32c0,0x2ce5,0x3503,0x36ea,0x2d05,0x2f80,0x2c32,
0x2829,0x1dc0,0x1d46,0x1657,0x12ba,0x0e86,0x15bb,0x12b8,
0x0dd0,0x065a,0x04aa,0x09a9,0x1177,0x1629,0x149b,0x189f,
0x205c,0x2e4b,0x2be5,0x2088,0x2ee8,0x327c,0x2f5e,0x35ff,
0x2d94,0x3320,0x2a4d,0x27ea,0x3288,0x1adb,0x2734,0x1d66,
0x19e8,0x22b5,0x1b71,0x1d9c,0x0d66,0x126e,0x0bfc,0x1558,
0x0e2b,0x100b,0x1841,0x148c,0x13bf,0x2357,0x1d43,0x25c8,
0x27ea,0x27af,0x20da,0x2a4c,0x34c7,0x256c,0x3648,0x3864,
0x32cb,0x2ffa,0x2d90,0x1917,0x1958,0x215e,0x27ac,0x0b17,
0x2176,0x1478,0x11f9,0x06fb,0x0ad3,0x198f,0x046a,0x0eb9,
0x1c74,0x1280,0x1d51,0x1f32,0x220f,0x28a4,0x23e4,0x2a0a,
0x25f6,0x3634,0x2709,0x34f4,0x38de,0x276f,0x33a2,0x274c,
0x25b7,0x2428,0x27a3,0x1391,0x1f4b,0x11ad,0x1804,0x1040
},
{
0x386b,0x35fd,0x2d42,0x317c,0x1f50,0x2a06,0x1bc6,0x1b17,
0x1d89,0x1342,0x2127,0x12cb,0x0cd7,0x12ba,0x1269,0x1314,
0x073c,0x1417,0x11c0,0x0fca,0x2074,0x1497,0x178c,0x252d,
0x3108,0x2a37,0x3203,0x37ea,0x2952,0x3570,0x3520,0x3144,
0x22fc,0x2cfe,0x3012,0x229f,0x24b1,0x254b,0x1f7f,0x22a9,
0x1a4b,0x19a1,0x1286,0x1650,0x0cbe,0x14eb,0x0bf0,0x1790,
0x1404,0x14a7,0x135a,0x1f80,0x26b7,0x2188,0x1eb0,0x2b5e,
0x2784,0x2bfc,0x36d1,0x2774,0x3332,0x2a73,0x28e8,0x289e,
0x2c7e,0x1935,0x2353,0x2720,0x1b49,0x1e21,0x1f38,0x0dfa,
0x10c0,0x1cdc,0x0f34,0x117a,0x181b,0x1234,0x0926,0x13ff,
0x1a49,0x167e,0x1522,0x26e1,0x2665,0x25aa,0x2f02,0x27fd,
0x2b9a,0x32c0,0x2ce5,0x3503,0x36ea,0x2d05,0x2f80,0x2c32,
0x2829,0x1dc0,0x1d46,0x1657,0x12ba,0x0e86,0x15bb,0x12b8,
0x0dd0,0x065a,0x04aa,0x09a9,0x1177,0x1629,0x149b,0x189f,
0x205c,0x2e4b,0x2be5,0x2088,0x2ee8,0x327c,0x2f5e,0x35ff,
0x2d94,0x3320,0x2a4d,0x27ea,0x3288,0x1adb,0x2734,0x1d66,
0x19e8,0x22b5,0x1b71,0x1d9c,0x0d66,0x126e,0x0bfc,0x1558,
0x0e2b,0x100b,0x1841,0x148c,0x13bf,0x2357,0x1d43,0x25c8,
0x27ea,0x27af,0x20da,0x2a4c,0x34c7,0x256c,0x3648,0x3864,
0x32cb,0x2ffa,0x2d90,0x1917,0x1958,0x215e,0x27ac,0x0b17,
0x2176,0x1478,0x11f9,0x06fb,0x0ad3,0x198f,0x046a,0x0eb9,
0x1c74,0x1280,0x1d51,0x1f32,0x220f,0x28a4,0x23e4,0x2a0a,
0x25f6,0x3634,0x2709,0x34f4,0x38de,0x276f,0x33a2,0x274c,
0x25b7,0x2428,0x27a3,0x1391,0x1f4b,0x11ad,0x1804,0x1040
}
};

/* Expected data */
ple_uint8_t expdata2ch[] = {
0x50,0x4c,0x43,0x30,0x04,0x00,0x02,0x01,0x00,0x00,0x3c,0x0e,0x40,0x03,0x00,0x00,
0x06,0x67,0xf8,0x04,0xb3,0xff,0x7f,0x17,0xf8,0x7f,0xd7,0xfd,0x3c,0x7f,0x83,0xf3,
0xfb,0xff,0x46,0xcf,0xef,0xf4,0x35,0xf9,0x7f,0xeb,0xda,0xfe,0x13,0x91,0x20,0xc4,
0xa7,0x89,0x7f,0xe7,0xd4,0xa6,0x5a,0xcd,0x0f,0xe2,0x58,0x03,0xfa,0xe1,0xff,0x5d,
0x87,0xe6,0xaf,0x0d,0xd9,0xd9,0xc4,0xcc,0x0b,0x4c,0x2c,0xd0,0x1a,0x9f,0x0a,0x71,
0xf5,0x99,0x7f,0x97,0xfc,0x8c,0xd4,0x64,0x9b,0x92,0xab,0x4e,0xbc,0xdf,0x33,0x8b,
0xb3,0x08,0xe9,0x56,0x50,0x44,0xdd,0x16,0x1b,0x8f,0xb0,0x6c,0xf1,0x15,0x7f,0x1d,
0x0a,0xd9,0xdd,0xb8,0x55,0xe2,0x8c,0x90,0x99,0xa6,0xd7,0x1c,0xc8,0x0a,0xc1,0x8b,
0x34,0x22,0x25,0x2b,0x0b,0x0b,0x13,0x50,0x14,0x86,0xfa,0xa3,0x36,0x53,0xff,0xb7,
0xfd,0x6b,0xaf,0xf0,0x0c,0x5b,0x20,0xe0,0xd1,0xf3,0x7f,0x32,0x5f,0x74,0xf1,0x30,
0x38,0xea,0xda,0xaf,0x21,0x9d,0xa3,0xc2,0x40,0x44,0x7f,0x6e,0x46,0x76,0xfe,0x17,
0xa1,0x02,0x59,0x4e,0x4d,0x12,0xaf,0xbb,0x24,0x30,0x60,0x85,0x6a,0x9d,0x9a,0x82,
0x0b,0x97,0x63,0x13
};

ple_uint8_t expdata4ch[] = {
0x50,0x4c,0x43,0x30,0x04,0x00,0x04,0x01,0x00,0x00,0x3c,0x0e,0x40,0x03,0x00,0x00,
0x06,0x67,0xf8,0x04,0xb3,0xff,0x7f,0x17,0xf8,0x7f,0xd7,0xfd,0x3c,0x7f,0x83,0xf3,
0xfb,0xff,0x46,0xcf,0xef,0xf4,0x35,0xf9,0x7f,0xeb,0xda,0xfe,0x13,0x91,0x20,0xc4,
0xa7,0x89,0x7f,0xe7,0xd4,0xa6,0x5a,0xcd,0x0f,0xe2,0x58,0x03,0xfa,0xe1,0xff,0x5d,
0x87,0xe6,0xaf,0x0d,0xd9,0xd9,0xc4,0xcc,0x06,0x67,0xf8,0x04,0xb3,0xff,0x7f,0x17,
0xf8,0x7f,0xd7,0xfd,0x3c,0x7f,0x83,0xf3,0xfb,0xff,0x46,0xcf,0xef,0xf4,0x35,0xf9,
0x7f,0xeb,0xda,0xfe,0x13,0x91,0x20,0xc4,0xa7,0x89,0x7f,0xe7,0xd4,0xa6,0x5a,0xcd,
0x0f,0xe2,0x58,0x03,0xfa,0xe1,0xff,0x5d,0x87,0xe6,0xaf,0x0d,0xd9,0xd9,0xc4,0xcc,
0x0b,0x4c,0x2c,0xd0,0x1a,0x9f,0x0a,0x71,0xf5,0x99,0x7f,0x97,0xfc,0x8c,0xd4,0x64,
0x9b,0x92,0xab,0x4e,0xbc,0xdf,0x33,0x8b,0xb3,0x08,0xe9,0x56,0x50,0x44,0xdd,0x16,
0x1b,0x8f,0xb0,0x6c,0xf1,0x15,0x7f,0x1d,0x0a,0xd9,0xdd,0xb8,0x55,0xe2,0x8c,0x90,
0x99,0xa6,0xd7,0x1c,0xc8,0x0a,0xc1,0x8b,0x34,0x22,0x25,0x2b,0x1a,0x9f,0x0a,0x71,
0xf5,0x99,0x7f,0x97,0xfc,0x8c,0xd4,0x64,0x9b,0x92,0xab,0x4e,0xbc,0xdf,0x33,0x8b,
0xb3,0x08,0xe9,0x56,0x50,0x44,0xdd,0x16,0x1b,0x8f,0xb0,0x6c,0xf1,0x15,0x7f,0x1d,
0x0a,0xd9,0xdd,0xb8,0x55,0xe2,0x8c,0x90,0x99,0xa6,0xd7,0x1c,0xc8,0x0a,0xc1,0x8b,
0x34,0x22,0x25,0x2b,0x0b,0x0b,0x13,0x50,0x14,0x86,0xfa,0xa3,0x36,0x53,0xff,0xb7,
0xfd,0x6b,0xaf,0xf0,0x0c,0x5b,0x20,0xe0,0xd1,0xf3,0x7f,0x32,0x5f,0x74,0xf1,0x30,
0x38,0xea,0xda,0xaf,0x21,0x9d,0xa3,0xc2,0x40,0x44,0x7f,0x6e,0x46,0x76,0xfe,0x17,
0xa1,0x02,0x59,0x4e,0x4d,0x12,0xaf,0xbb,0x24,0x30,0x60,0x85,0x6a,0x9d,0x9a,0x82,
0x14,0x86,0xfa,0xa3,0x36,0x53,0xff,0xb7,0xfd,0x6b,0xaf,0xf0,0x0c,0x5b,0x20,0xe0,
0xd1,0xf3,0x7f,0x32,0x5f,0x74,0xf1,0x30,0x38,0xea,0xda,0xaf,0x21,0x9d,0xa3,0xc2,
0x40,0x44,0x7f,0x6e,0x46,0x76,0xfe,0x17,0xa1,0x02,0x59,0x4e,0x4d,0x12,0xaf,0xbb,
0x24,0x30,0x60,0x85,0x6a,0x9d,0x9a,0x82,0x0b,0x97,0x63,0x13
};


/* Sample program */
int main()
{
	HPLE		hPle = NULL;   /* Encoder */
	plc_uint8_t	*pucItem = NULL;  /* Encoded data */
	plc_uint8_t	*rp;
	plc_size_t	nItemSize;
	ple_uint16_t	**ppusWave = NULL;  /* Input */
	ple_uint8_t	*encoded_result = NULL; /* output */
	ple_uint8_t	*wp, *expdata;

	/* Input Attribute */
	uint8_t		ucFundamentalFrq  = 60;
//	uint8_t		ucCurrentChannels = 4;
	uint8_t		ucCurrentChannels = 2;
	uint8_t		ucVoltageChannels = 1;
	uint8_t		ucSamplesPerFrame = 64;
	uint8_t		ucFramesPerGroup  = 3;
	int		nChannels;
	int		i, j, k, l, result_size;
	ple_code_t	ier_e;


	printf("ucFundamentalFrq  : %d\n", ucFundamentalFrq);
	printf("ucCurrentChannels : %d\n", ucCurrentChannels);
	printf("ucVoltageChannels : %d\n", ucVoltageChannels);
	printf("ucSamplesPerFrame : %d\n", ucSamplesPerFrame);
	printf("ucFramesPerGroup  : %d\n", ucFramesPerGroup);
	printf("\n");
	printf("==================================================\n");
	printf("                PLE simple check\n");
	printf("==================================================\n");

	/* Initialize */
	PLEInitialize(&hPle, NULL, 0);

	/* Alloc */
	/* array of pointer to each channel of single waveform buffer */
	nChannels = ucCurrentChannels + ucVoltageChannels;
	ppusWave = (ple_uint16_t **)malloc((size_t)nChannels*sizeof(ple_uint16_t *));
	if(ppusWave == NULL) {
		fprintf(stderr, " ### Error: Memory Allocation ###\n");
		goto Finish;
	}
	memset(ppusWave, 0, (size_t)nChannels*sizeof(ple_uint16_t *));

	/* buffer of each channel */
	/* To reduce working memory, you should modify PLC_SAMPLES_PER_FRAME_MAX to the appropriate value for your system */
	for(i=0; i<nChannels; i++) {
		ppusWave[i] = (ple_uint16_t *)malloc(PLC_SAMPLES_PER_FRAME_MAX*sizeof(ple_uint16_t));
		if(ppusWave[i] == NULL) {
			fprintf(stderr, " ### Error: Memory Allocation ###\n");
			goto Finish;
		}
	}

	/* buffer of encoded data */
	result_size = PLC_HEADER_SIZE+(ucCurrentChannels*PLC_L_DATA_SIZE+ucVoltageChannels*PLC_V_DATA_SIZE)*ucFramesPerGroup;
	wp = encoded_result = (ple_uint8_t *)malloc(result_size);

	/* PreProcess */
	ier_e = PLEPreProcess(hPle,
			(ple_uint8_t)ucFundamentalFrq,
			(ple_uint8_t)ucCurrentChannels,
			(ple_uint8_t)ucVoltageChannels,
			(ple_uint8_t)ucSamplesPerFrame,
			(ple_uint8_t)ucFramesPerGroup);
	if(ier_e < 0) {
		fprintf(stderr, " ### Error: PLEPreProcess: %d ###\n", ier_e);
		goto Finish;
	}


	/* Loop */
	for(j=0;j<ucFramesPerGroup;j++){
      
		/* preparing wave data (1 sec) */
		for(l=0;l<nChannels;l++){
			for(i=0;i<ucSamplesPerFrame;i++){
				if(l<ucCurrentChannels){
					ppusWave[l][i] = L_in[l][i+j*ucSamplesPerFrame];
				}
				else {
					ppusWave[l][i] = V_in[l-ucCurrentChannels][i+j*ucSamplesPerFrame];
				}
			}
		}

		/* Put data to PLE */
		ier_e = PLEPutData(hPle, (const ple_uint16_t **)ppusWave);
		if(ier_e < 0) {
			fprintf(stderr, " ### Error: PLEPutData: %d ###\n", ier_e);
			goto Finish;
		}

		/* Get result from PLE */
		while(1) {

			/* Get result size */
			ier_e = PLEGetResultSize(hPle, &nItemSize);
			if(ier_e == PLE_RESULT_NONE) {
				break;
			}
			else if(ier_e < 0) {
				fprintf(stderr, " ### Error: PLEGetResultSize: %d ###\n", ier_e);
				goto Finish;
			}

			/* Alloc */
			pucItem = (plc_uint8_t *)realloc((void *)pucItem, nItemSize);
			if(pucItem == NULL) {
				fprintf(stderr, " ### Error: Memory Allocation ###\n");
				goto Finish;
			}
			else {
				rp = pucItem;
			}

			/* Get result */
			ier_e = PLEGetResult(hPle, pucItem);
			if(ier_e == PLE_RESULT_NONE) {
				break;
			}
			else if(ier_e < 0) {
				fprintf(stderr, " ### Error: PLEGetResult: %d ###\n", ier_e);
				goto Finish;
			}
      
			/* Save result */
			for(k=0;k<nItemSize;k++){
				*wp++ = *rp++;
			}
		}
	}

	/* CHECK RESULT */
	wp = encoded_result;
	if(ucCurrentChannels == 2){
		expdata = expdata2ch;
	}
	else {
		expdata = expdata4ch;
	}

	i = 0;
	while(result_size--){
		if(*wp++ != *expdata++){
			fprintf(stderr, " !!! ENCODE ERROR !!!\n");
			goto Finish;
		}
	}
	fprintf(stderr, "==================  ENCODE OK ====================\n");

Finish:
	/* Release */
	PLEFinalize(&hPle);
	if(pucItem != NULL) {
		free(pucItem);
	}
	if(ppusWave != NULL) {
		for(i=0; i<nChannels; i++) {
			if(ppusWave[i] != NULL) {
				free(ppusWave[i]);
			}
		}
		free(ppusWave);
	}
	if(encoded_result != NULL) {
		free(encoded_result);
	}

	/* Ending */
	return(0);
}

/* ----------------------------------------------------------------
                  End of File: SONY Confidential
 ---------------------------------------------------------------- */

